(()=>{let e={},t={},n={},a=[],o=[],s=null,l=null,i={},r=!1;const c=_.template($("#tab-template").html()),d=_.template($("#page-template").html()),u=_.template($("#seat-template").html()),p=_.template($("#pair-template").html()),m=document.getElementById("input-video"),f=$("#before-streaming-title"),b=$("#device-input-preview-area"),g=$("#rtmp-input-preview-area"),v=$("#capture-select-area"),E=$("#source-select-area"),h=$("#video-source-select"),C=$("#audio-source-select"),y=$(".constraints-select"),I=$("#rtmp-input-url-input"),T=$("#rtmp-input-streamkey-input"),P=$("#srt-input-url-input"),A=$("#waiting-rtmp-input-text"),M=$("#connected-rtmp-input-text"),O=$("#share-device-button"),S=$("#share-display-button"),R=$("#share-rtmp-button"),x=$(".back-to-capture-select-button"),L=$("#start-share-button"),D=$("#input-error-message"),G=$("#input-device-modal"),k=$("#total-user-count-span"),N=$("#video-user-count-span");function B(e,t,n){t.empty(),0===n.length?t.append('<option value="">No Source Available</option>'):_.each(n,(function(e){let n=$("<option></option>");n.text(e.label),n.val(e.deviceId),t.append(n)})),t.find("option").eq(0).prop("selected",!0)}function U(e,t){return e.filter((function(e){return e!=t}))}function w(){const e=OvenLiveKit.create({callbacks:{connected:function(){console.log("App Connected"),r&&(function(e){const t=$("#seat-"+e);t.addClass("seat-on"),t.find(".local-player-area").removeClass("d-none"),document.getElementById("local-player-"+e).srcObject=i[e].inputStream}(s),G.modal("hide"),r=!1)},connectionClosed:function(e,t){console.log("App Connection Closed"),"websocket"===e&&console.log("app websocket closed"),"ice"===e&&console.log("app ice closed")},iceStateChange:function(e){console.log("App ICE State",e)},error:function(e){console.log("App Error On OvenLiveKit",e),r&&(a=U(a,s),o=U(o,s),r=!1),F(e)}}});e.attachMedia(m);let t=null;"device"===l&&e.getUserMedia(function(){let e=h.val(),t=C.val(),n={};return e&&(n.video={deviceId:{exact:e}}),t&&(n.audio={deviceId:{exact:t}}),n}()).then((function(e){})).catch((function(e){W(),t=e})).finally((function(){j(),b.removeClass("d-none"),E.removeClass("d-none"),t&&F(t)})),"display"===l&&e.getDisplayMedia({video:!0,audio:!0}).then((function(e){})).catch((function(e){W(),t=e})).finally((function(){j(),b.removeClass("d-none"),E.addClass("d-none"),t&&F(t)})),i[s]=e}function j(){v.addClass("d-none"),D.addClass("d-none").text(""),"device"!==l&&"display"!==l||(b.find("button").prop("disabled",!1),"device"===l?f.text("Click start button to share your WebCam / Mic"):"display"===l&&f.text("Click start button to share screen")),"rtmp"===l&&(g.find("button").prop("disabled",!1),g.removeClass("d-none"),f.text("Send the input stream using a live encoder."),I.val(OME_RTMP_INPUT_URL),T.val(s),P.val(OME_SRT_INPUT_URL+encodeURIComponent(s)))}function H(){m.srcObject=null,l=null,b.addClass("d-none"),b.find("button").prop("disabled",!0),g.addClass("d-none"),g.find("button").prop("disabled",!0),A.removeClass("d-none"),M.addClass("d-none"),f.text("Please choose sharing mode"),v.removeClass("d-none"),D.addClass("d-none").text("")}function W(){K(s),H()}function F(e){let t="";t=e.message?e.message:e.name?e.name:e.toString(),"OverconstrainedError"===t&&(t="The input device does not support the specified resolution or frame rate."),"Cannot create offer"===t&&(t="Cannot create stream."),D.removeClass("d-none").text(t)}function K(e){i[e]&&(i[e].remove(),i[e]=null,delete i[e])}function q(e){console.log(">>> destroyPlayer",e),a=U(a,e),o=U(o,e);const t=$("#seat-"+e);t.removeClass("seat-on"),t.find(".player-area").addClass("d-none");const s=OvenPlayer.getPlayerByContainerId("player-"+e);s&&s.remove(),t.find(".local-player-area").addClass("d-none");const l=document.getElementById("local-player-"+e);l&&(l.srcObject=null),K(e),n[e]=!1,Q(e)}function X(e){if(200===e.statusCode){const t=e.response,i=[];o.forEach((e=>{t.includes(e)||i.push(e)})),i.forEach((e=>{t.push(e)})),t.forEach(((e,t)=>{a.includes(e)||("rtmp"===l&&e===s&&(A.addClass("d-none"),M.removeClass("d-none"),setTimeout((function(){G.modal("hide")}),4e3)),setTimeout((function(){console.log(">>> createPlayer",e),function(e){const t=$("#seat-"+e);t.addClass("seat-on"),t.find(".player-area").removeClass("d-none");let a=null;a="E"==e.substring(0,1)?"player_edge_"+e.substring(e.length-1):"player_terminal_"+e.substring(e.length-1);const o={autoFallback:!1,autoStart:!0,sources:[{label:"WebRTC",type:"webrtc",file:OME_WEBRTC_STREAMING_HOST+"/"+APP_NAME+"/"+e+"?transport=tcp"},{label:"LLHLS",type:"llhls",file:OME_LLHLS_STREAMING_HOST+"/"+APP_NAME+"/"+e+"/llhls.m3u8"}]};OvenPlayer.create(document.getElementById("player-"+e),o).on("error",(function(t){console.log("App Error On Player",t),q(e)})),OvenPlayer.create(document.getElementById(a),o).on("error",(function(t){console.log("App Error On Player2",t),q(e)})),n[e]=!0,Q(e)}(e)}),200*t))})),a.forEach((e=>{t.includes(e)||o.includes(e)||q(e)})),a=t,N.text(a.length)}}function z(){(async function(){return await $.ajax({method:"get",url:"/getStreams"})})().then(X).catch((function(e){console.error("Could not get streams from OME.")}))}function J(t){let n=e[t],a=document.getElementsByClassName("tabcontent");for(let e=0;e<a.length;e++)a[e].classList.add("d-none");let o=document.getElementsByClassName("tablinks");for(let e=0;e<o.length;e++)o[e].classList.remove("curtab");document.getElementById(n).classList.remove("d-none"),document.getElementById(t).classList.add("curtab")}function Q(e){let a=t[e],o="pair_tab_"+e.substring(e.length-1);"False"==REGISTER_MODE&&(n[e]&&n[a]?$("#"+o).removeClass("d-none"):($("#"+o).addClass("d-none"),$("#"+o).hasClass("curtab")&&J("tab_1")))}navigator.mediaDevices.getDisplayMedia||S.addClass("d-none"),O.on("click",(function(){l="device",OvenLiveKit.getDevices().then((function(e){e&&(B(0,h,e.videoinput),B(0,C,e.audioinput)),w()})).catch((function(e){F(e)}))})),y.on("change",(function(){K(s),w()})),R.on("click",(function(){l="rtmp",j()})),S.on("click",(function(){l="display",w()})),x.on("click",(function(){W()})),L.on("click",(function(){s&&i[s]&&(r=!0,o.push(s),a.push(s),i[s].startStreaming(OME_WEBRTC_INPUT_HOST+"/"+APP_NAME+"/"+s+"?direction=send&transport=tcp"))})),G.on("hidden.bs.modal",(function(){H()})),io({transports:["websocket"]}).on("user count",(function(e){k.text(e.user_count)})),"True"==REGISTER_MODE?$("#title").removeClass("d-none"):function(){const t="page_0",n=$(d({pageID:t,pageType:"dashboard-area"})),a="tab_0",o=$(c({tabID:a}));o.text("Overview"),$("#page-area").append(n),$(".tab").append(o),e[a]=t,$.get("/dashboard",(function(e){let t=document.createElement("div");$.each($(e),(function(e,n){t.append(n)})),$("#dashboard-area").append($(t).find("#dashboard"))})).catch((function(e){F(e)}))}(),function(){for(let t=0;t<SEAT_PAGES;t++){const n=t+1,a="page_"+n,o=$(d({pageID:a,pageType:"seat-area"})),s="tab_"+n,l=$(c({tabID:s}));l.text(0==t?"EDGE GPU":"TERMINAL"),$("#page-area").append(o),$(".tab").append(l),e[s]=a}}(),function(){let e=$("[id=seat-area]");for(let a=0;a<SEAT_PAGES;a++){let o=0==a?"EDGE_GPU":"TERMINAL",l=0==a?"TERMINAL":"EDGE_GPU";for(let i=0;i<MAX_STREAM_PER_PAGE;i++){const r=i+1,c=o+"_"+r,d=$(u({streamName:c}));let p=c.replace(/_/g," ");d.find("#stream-name").text(p),"False"==REGISTER_MODE?d.find(".join-button ").addClass("d-none"):(d.find(".join-button ").data("stream-name",c),d.find(".join-button ").on("click",(function(e){s=$(this).data("stream-name"),G.modal("show")})),d.on("mouseenter",(function(){d.find(".leave-button").stop().fadeIn()})),d.on("mouseleave",(function(){d.find(".leave-button").stop().fadeOut()})),d.find(".leave-button ").data("stream-name",c),d.find(".leave-button").on("click",(function(){q($(this).data("stream-name"))}))),e.eq(a).append(d),t[c]=l+"_"+r,n[c]=!1}}}(),function(){for(let t=0;t<MAX_STREAM_PER_PAGE;t++){const n=t+1,a="pair_page_"+n,o=$(d({pageID:a,pageType:"pair-area"})),s="pair_tab_"+n,l=$(c({tabID:s}));l.text("Pair "+n),l.addClass("d-none"),$("#page-area").append(o),$(".tab").append(l),e[s]=a;const i=$(p({idx:n}));i.find("#pair_edge_"+n).find("#stream-name").text("EDGE GPU "+n),i.find("#pair_terminal_"+n).find("#stream-name").text("TERMINAL "+n),o.append(i)}}(),"True"==REGISTER_MODE?J("tab_1"):J("tab_0"),z(),setInterval((()=>{z()}),2500)})();