(()=>{let e=[],t=[],n=null,o=null,a={},s=!1;const c=_.template($("#tab-template").html()),i=_.template($("#page-template").html()),l=_.template($("#seat-template").html()),d=document.getElementById("input-video"),r=$("#before-streaming-title"),u=$("#device-input-preview-area"),p=$("#rtmp-input-preview-area"),m=$("#capture-select-area"),f=$("#source-select-area"),v=$("#video-source-select"),h=$("#audio-source-select"),b=$(".constraints-select"),g=$("#rtmp-input-url-input"),C=$("#rtmp-input-streamkey-input"),y=$("#srt-input-url-input"),E=$("#waiting-rtmp-input-text"),A=$("#connected-rtmp-input-text"),S=$("#share-device-button"),O=$("#share-display-button"),M=$("#share-rtmp-button"),P=$(".back-to-capture-select-button"),T=$("#start-share-button"),I=$("#input-error-message"),k=$("#input-device-modal"),x=$("#total-user-count-span"),L=$("#video-user-count-span");function N(e,t,n){t.empty(),0===n.length?t.append('<option value="">No Source Available</option>'):_.each(n,(function(e){let n=$("<option></option>");n.text(e.label),n.val(e.deviceId),t.append(n)})),t.find("option").eq(0).prop("selected",!0)}function R(e,t){return e.filter((function(e){return e!=t}))}function B(){const c=OvenLiveKit.create({callbacks:{connected:function(){console.log("App Connected"),s&&(function(e){const t=$("#seat-"+e);t.addClass("seat-on"),t.find(".local-player-area").removeClass("d-none"),document.getElementById("local-player-"+e).srcObject=a[e].inputStream}(n),k.modal("hide"),s=!1)},connectionClosed:function(e,t){console.log("App Connection Closed"),"websocket"===e&&console.log("app websocket closed"),"ice"===e&&console.log("app ice closed")},iceStateChange:function(e){console.log("App ICE State",e)},error:function(o){console.log("App Error On OvenLiveKit",o),s&&(e=R(e,n),t=R(t,n),s=!1),D(o)}}});c.attachMedia(d);let i=null;"device"===o&&c.getUserMedia(function(){let e=v.val(),t=h.val(),n={};return e&&(n.video={deviceId:{exact:e}}),t&&(n.audio={deviceId:{exact:t}}),n}()).then((function(e){})).catch((function(e){j(),i=e})).finally((function(){w(),u.removeClass("d-none"),f.removeClass("d-none"),i&&D(i)})),"display"===o&&c.getDisplayMedia({video:!0,audio:!0}).then((function(e){})).catch((function(e){j(),i=e})).finally((function(){w(),u.removeClass("d-none"),f.addClass("d-none"),i&&D(i)})),a[n]=c}function w(){m.addClass("d-none"),I.addClass("d-none").text(""),"device"!==o&&"display"!==o||(u.find("button").prop("disabled",!1),"device"===o?r.text("Click start button to share your WebCam / Mic"):"display"===o&&r.text("Click start button to share screen")),"rtmp"===o&&(p.find("button").prop("disabled",!1),p.removeClass("d-none"),r.text("Send the input stream using a live encoder."),g.val(OME_RTMP_INPUT_URL),C.val(n),y.val(OME_SRT_INPUT_URL+encodeURIComponent(n)))}function U(){d.srcObject=null,o=null,u.addClass("d-none"),u.find("button").prop("disabled",!0),p.addClass("d-none"),p.find("button").prop("disabled",!0),E.removeClass("d-none"),A.addClass("d-none"),r.text("Please choose sharing mode"),m.removeClass("d-none"),I.addClass("d-none").text("")}function j(){H(n),U()}function D(e){let t="";t=e.message?e.message:e.name?e.name:e.toString(),"OverconstrainedError"===t&&(t="The input device does not support the specified resolution or frame rate."),"Cannot create offer"===t&&(t="Cannot create stream."),I.removeClass("d-none").text(t)}function G(){n&&a[n]&&(s=!0,t.push(n),e.push(n),a[n].startStreaming(OME_WEBRTC_INPUT_HOST+"/"+APP_NAME+"/"+n+"?direction=send&transport=tcp"))}function H(e){a[e]&&(a[e].remove(),a[e]=null,delete a[e])}function K(n){console.log(">>> destroyPlayer",n),e=R(e,n),t=R(t,n);const o=$("#seat-"+n);o.removeClass("seat-on"),o.find(".player-area").addClass("d-none");const a=OvenPlayer.getPlayerByContainerId("player-"+n);a&&a.remove(),o.find(".local-player-area").addClass("d-none");const s=document.getElementById("local-player-"+n);s&&(s.srcObject=null),H(n)}function W(a){if(200===a.statusCode){const s=a.response,c=[];t.forEach((e=>{s.includes(e)||c.push(e)})),c.forEach((e=>{s.push(e)})),s.forEach(((t,a)=>{e.includes(t)||("rtmp"===o&&t===n&&(E.addClass("d-none"),A.removeClass("d-none"),setTimeout((function(){k.modal("hide")}),4e3)),setTimeout((function(){console.log(">>> createPlayer",t),function(e){const t=$("#seat-"+e);t.addClass("seat-on"),t.find(".player-area").removeClass("d-none");const n={autoFallback:!1,autoStart:!0,sources:[{label:"WebRTC",type:"webrtc",file:OME_WEBRTC_STREAMING_HOST+"/"+APP_NAME+"/"+e+"?transport=tcp"},{label:"LLHLS",type:"llhls",file:OME_LLHLS_STREAMING_HOST+"/"+APP_NAME+"/"+e+"/llhls.m3u8"}]};OvenPlayer.create(document.getElementById("player-"+e),n).on("error",(function(t){console.log("App Error On Player",t),K(e)}))}(t)}),200*a))})),e.forEach((e=>{s.includes(e)||t.includes(e)||K(e)})),e=s,L.text(e.length)}}function q(){(async function(){return await $.ajax({method:"get",url:"/getStreams"})})().then(W).catch((function(e){console.error("Could not get streams from OME.")}))}navigator.mediaDevices.getDisplayMedia||O.addClass("d-none"),S.on("click",(function(){o="device",OvenLiveKit.getDevices().then((function(e){e&&(N(0,v,e.videoinput),N(0,h,e.audioinput)),B()})).catch((function(e){D(e)}))})),b.on("change",(function(){H(n),B()})),M.on("click",(function(){o="rtmp",w()})),O.on("click",(function(){o="display",B()})),P.on("click",(function(){j()})),T.on("click",(function(){G()})),k.on("hidden.bs.modal",(function(){U()})),io({transports:["websocket"]}).on("user count",(function(e){x.text(e.user_count)})),function(){for(let e=0;e<SEAT_PAGES;e++){const t=$(i({pageNum:e+1})),n=$(c({id:e+1}));n.text("TAB "+(e+1)),$("#page-area").append(t),$(".tab").append(n)}}(),function(){let e=$("[id=seat-area]");for(let t=0;t<SEAT_PAGES;t++)for(let a=0;a<MAX_STREAM_PER_PAGE;a++){const s=STREAM_NAME+"-t"+t+"s"+a,c=$(l({streamName:s}));c.find(".join-button ").data("stream-name",s),c.find(".join-button ").on("click",(function(e){n=$(this).data("stream-name"),o="device",OvenLiveKit.getDevices().then((function(e){e&&(N(0,v,e.videoinput),N(0,h,e.audioinput)),B(),G()})).catch((function(e){D(e)}))})),c.on("mouseenter",(function(){c.find(".leave-button").stop().fadeIn()})),c.on("mouseleave",(function(){c.find(".leave-button").stop().fadeOut()})),c.find(".leave-button ").data("stream-name",s),c.find(".leave-button").on("click",(function(){K($(this).data("stream-name"))})),e.eq(t).append(c)}}(),function(e,t){let n=document.getElementsByClassName("tabcontent");for(let e=0;e<n.length;e++)n[e].classList.add("d-none");let o=document.getElementsByClassName("tablinks");for(let e=0;e<o.length;e++)o[e].classList.remove("curtab");document.getElementById("disp_1").classList.remove("d-none"),document.getElementById("button_1").classList.add("curtab")}(),q(),setInterval((()=>{q()}),2500)})();